<script src="https://cdn.tailwindcss.com"></script>
<!-- Set default font to Inter -->
<style>
    body {
        font-family: 'Inter', sans-serif;
    }
</style>
<!-- Include React and ReactDOM CDNs -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<!-- Include Babel for JSX transformation -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <div id="root"></div>

    <script type="text/babel">
        // React component code starts here
        const { useState, useEffect } = React;

        // Main App component for the file uploader
        function App() {
            // State to store the selected workflow file
            const [workflowFile, setWorkflowFile] = useState(null);
            // State to store the selected additional files
            const [additionalFiles, setAdditionalFiles] = useState([]);
            // State to store the usecase ID, parsed from the URL
            const [usecaseId, setUsecaseId] = useState('');
            // State to manage loading status during upload
            const [loading, setLoading] = useState(false);
            // State to store upload results received from the server
            const [uploadResult, setUploadResult] = useState(null);
            // State to store any error messages during upload
            const [error, setError] = useState(null);

            // Effect to parse the usecase ID from the URL when the component mounts
            useEffect(() => {
                const path = window.location.pathname;
                const parts = path.split('/');
                const workflowAddIndex = parts.indexOf('workflow_add');
                let parsedUsecaseId = '';

                // Check if 'workflow_add' is in the path and if there's a segment after it
                if (workflowAddIndex !== -1 && workflowAddIndex + 1 < parts.length) {
                    parsedUsecaseId = parts[workflowAddIndex + 1];
                }

                // If a usecase ID is found, set it in the state
                if (parsedUsecaseId) {
                    setUsecaseId(parsedUsecaseId);
                    setError(null); // Clear any previous errors if ID is found
                } else {
                    // If no usecase ID is found, set an error message
                    setError('Use Case ID could not be found in the URL. Please ensure the URL is in the format /workflow_add/<usecase_name>.');
                }
            }, []); // Empty dependency array means this runs once on mount

            /**
             * Handles changes to the workflow file input.
             * Updates the workflowFile state.
             * @param {Object} event - The change event from the file input.
             */
            const handleWorkflowFileChange = (event) => {
                setWorkflowFile(event.target.files[0]);
                setUploadResult(null); // Clear previous results on new file selection
                setError(null);       // Clear previous errors
            };

            /**
             * Handles changes to the additional files input.
             * Updates the additionalFiles state.
             * @param {Object} event - The change event from the file input.
             */
            const handleAdditionalFilesChange = (event) => {
                setAdditionalFiles(Array.from(event.target.files));
                setUploadResult(null); // Clear previous results on new file selection
                setError(null);       // Clear previous errors
            };

            /**
             * Handles the file upload process when the upload button is clicked.
             * Sends a POST request to the FastAPI endpoint with the selected files.
             */
            const handleUpload = async () => {
                if (!usecaseId) {
                    setError('Use Case ID is missing. Cannot upload files.');
                    return;
                }
                if (!workflowFile) {
                    setError('Please select a main workflow file.');
                    return;
                }

                setLoading(true);    // Set loading to true while upload is in progress
                setError(null);      // Clear any previous errors
                setUploadResult(null); // Clear any previous results

                const formData = new FormData(); // Create a new FormData object

                // Append the main workflow file
                formData.append('workflow_file', workflowFile);

                // Append each additional file
                additionalFiles.forEach(file => {
                    formData.append('additional_files', file); // 'additional_files' must match the FastAPI endpoint's parameter name
                });

                try {
                    // Construct the endpoint URL with the dynamic usecaseId
                    const endpoint = `http://localhost:8005/usecases/${usecaseId}/workflows`;

                    // Send the POST request to the FastAPI endpoint
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        body: formData, // FormData automatically sets 'Content-Type': 'multipart/form-data'
                    });

                    // Check if the response was successful
                    if (!response.ok) {
                        // If not successful, throw an error with the status text
                        throw new Error(`Upload failed with status: ${response.status} ${response.statusText}`);
                    }

                    // Parse the JSON response from the server
                    const data = await response.json();
                    setUploadResult(data); // Store the upload result
                } catch (err) {
                    console.error('Error uploading files:', err);
                    setError(`Failed to upload files: ${err.message}`); // Set the error message
                } finally {
                    setLoading(false); // Set loading to false once the upload is complete
                    // Clear selected files after upload attempt
                    setWorkflowFile(null);
                    setAdditionalFiles([]);
                    // usecaseId is not cleared as it's from the URL
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
                        <h1 className="text-3xl font-extrabold text-gray-800 mb-6 text-center">
                            Workflow upload
                        </h1>

                        {/* Display parsed Usecase ID */}
                        {usecaseId && (
                            <div className="mb-4 p-3 rounded-lg bg-blue-50 border border-blue-200 text-blue-700">
                                <p className="text-sm">
                                    <span className="font-bold">Use Case ID:</span> {usecaseId} (parsed from URL)
                                </p>
                            </div>
                        )}

                        {/* Workflow file input section */}
                        <div className="mb-6">
                            <label htmlFor="workflow-file-input" className="block text-gray-700 text-sm font-bold mb-2">
                                Select Main Workflow File:
                            </label>
                            <input
                                type="file"
                                id="workflow-file-input"
                                onChange={handleWorkflowFileChange}
                                className="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
                                aria-label="Workflow file selection input"
                            />
                            {workflowFile && (
                                <p className="mt-2 text-sm text-gray-600">
                                    Selected: {workflowFile.name}
                                </p>
                            )}
                        </div>

                        {/* Additional files input section */}
                        <div className="mb-6">
                            <label htmlFor="additional-files-input" className="block text-gray-700 text-sm font-bold mb-2">
                                Select Additional Files (Optional):
                            </label>
                            <input
                                type="file"
                                id="additional-files-input"
                                multiple // Allows selecting multiple files
                                onChange={handleAdditionalFilesChange}
                                className="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
                                aria-label="Additional files selection input"
                            />
                            {additionalFiles.length > 0 && (
                                <p className="mt-2 text-sm text-gray-600">
                                    Selected {additionalFiles.length} additional file(s).
                                </p>
                            )}
                        </div>

                        {/* Upload button */}
                        <button
                            onClick={handleUpload}
                            // Disable button when loading, no usecaseId, or no workflowFile
                            disabled={loading || !usecaseId || !workflowFile}
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition ease-in-out duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                        >
                            {loading ? (
                                <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            ) : (
                                'Upload Files'
                            )}
                        </button>

                        {/* Display error messages */}
                        {error && (
                            <div role="alert" className="mt-6 p-4 rounded-lg bg-red-100 border border-red-400 text-red-700">
                                <p className="font-bold">Error:</p>
                                <p className="text-sm">{error}</p>
                            </div>
                        )}

                        {/* Display upload results */}
                        {uploadResult && (
                            <div className="mt-6 p-4 rounded-lg bg-green-100 border border-green-400 text-green-700">
                                <h2 className="font-bold text-lg mb-2">Upload Successful!</h2>

                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Render the App component into the 'root' div
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        // React component code ends here
    </script>